const PANEL_BOARD_BASE_SECTION=[{partID:"315/400A",name:"400A Panel Board Base",cost:0}],INCOMER_TYPES=[{partID:"PB3153/ICM",name:"315A MCCB 3P",cost:0},{partID:"PB4003/ICM",name:"400A MCCB 3P",cost:0},{partID:"PB3154/ICM",name:"315A MCCB 4P",cost:0},{partID:"PB4004/ICM",name:"400A MCCB 4P",cost:0},{partID:"PB3154/ICS",name:"400A MCCB 4P Switch",cost:0}],SPINE_TYPES=[{partID:"PB400/06",name:"400A Board 6TP Ways",max:6,cost:0},{partID:"PB400/06+2",name:"400A Board 6+2TP Ways",max:6,supportsLargeOutgoer:!0,cost:0},{partID:"PB400/08",name:"400A Board 8TP Ways",max:8,cost:0},{partID:"PB400/08+2",name:"400A Board 8+2TP Ways",max:8,supportsLargeOutgoer:!0,cost:0},{partID:"PB400/12",name:"400A Board 12TP Ways",max:12,cost:0},{partID:"PB400/12+2",name:"400A Board 12+2TP Ways",max:12,supportsLargeOutgoer:!0,cost:0},{partID:"PB400/16",name:"400A Board 16TP Ways",max:16,cost:0},{partID:"PB400/16+2",name:"400A Board 16+2TP Ways",max:16,supportsLargeOutgoer:!0,cost:0}],OUTGOER_LESSTHAN_125A_TYPES=[{partID:"MC1P016",name:"16A MCCB 1P",spaceRequired:1,cost:0},{partID:"MC1P020",name:"20A MCCB 1P",spaceRequired:1,cost:0},{partID:"MC1P025",name:"25A MCCB 1P",spaceRequired:1,cost:0},{partID:"MC1P032",name:"32A MCCB 1P",spaceRequired:1,cost:0},{partID:"MC1P040",name:"40A MCCB 1P",spaceRequired:1,cost:0},{partID:"MC1P050",name:"50A MCCB 1P",spaceRequired:1,cost:0},{partID:"MC1P063",name:"63A MCCB 1P",spaceRequired:1,cost:0},{partID:"MC1P080",name:"80A MCCB 1P",spaceRequired:1,cost:0},{partID:"MC1P100",name:"100A MCCB 1P",spaceRequired:1,cost:0},{partID:"MC1P125",name:"125A MCCB 1P",spaceRequired:1,cost:0},{partID:"MC3P016",name:"16A MCCB 3P",spaceRequired:3,cost:0},{partID:"MC3P020",name:"20A MCCB 3P",spaceRequired:3,cost:0},{partID:"MC3P025",name:"25A MCCB 3P",spaceRequired:3,cost:0},{partID:"MC3P032",name:"32A MCCB 3P",spaceRequired:3,cost:0},{partID:"MC3P040",name:"40A MCCB 3P",spaceRequired:3,cost:0},{partID:"MC3P050",name:"50A MCCB 3P",spaceRequired:3,cost:0},{partID:"MC3P063",name:"63A MCCB 3P",spaceRequired:3,cost:0},{partID:"MC3P080",name:"80A MCCB 3P",spaceRequired:3,cost:0},{partID:"MC3P100",name:"100A MCCB 3P",spaceRequired:3,cost:0},{partID:"MC3P125",name:"125A MCCB 3P",spaceRequired:3,cost:0}],OUTGOER_125A_OR_MORE_TYPES=[{partID:"MC3P160",name:"160A MCCB 3P",cost:0},{partID:"MC3P200",name:"200A MCCB 3P",cost:0},{partID:"MC3P250",name:"250A MCCB 3P",cost:0}],ACCESSORIES=[{partID:"PB/SPD-100KA",name:"Surge Kit",cost:0},{partID:"PB400-MID",name:"Meter Kit",cost:0},{partID:"PB/KL",name:"Key Lock",cost:0},{partID:"PB400/AB",name:"Type A accessory Box",cost:0},{partID:"PB400/EB",name:"Extension Box",cost:0},{partID:"PB/TS",name:"TERMINAL SHROUD",cost:0}],PICKERS=[{id:"c0",title:"Step One: Panel Board Base",type:"single",palette:PANEL_BOARD_BASE_SECTION},{id:"c1",title:"Step Two: Incomer – Choose one only",type:"single",palette:INCOMER_TYPES},{id:"c2",title:"Step Three: Spine – Choose one only",type:"single",palette:SPINE_TYPES},{id:"c3",title:"Step Four: Outgoer > 125A - Maximum 2 Units",type:"multi",max:2,palette:OUTGOER_125A_OR_MORE_TYPES,allowQuantity:!0},{id:"c4",title:"Step Five: Outgoer ≤ 125A",type:"multi",max:18,palette:OUTGOER_LESSTHAN_125A_TYPES,allowQuantity:!0},{id:"c5",title:"Step Six: Accessories",type:"multi",max:7,palette:ACCESSORIES,allowQuantity:!0}],state={};PICKERS.forEach((t=>{state[t.id]=[],t.allowQuantity&&(state[t.id+"_qty"]={})})),state.terminalShroudUserChanged=!1,state.extraNotes="",state.disclaimerAgreed=!1;const TERMINAL_SHROUD_PID="PB/TS",pickersRoot=document.getElementById("pickers"),productDiv=document.querySelector(".product"),downloadBtn=document.getElementById("download"),mailBtn=document.getElementById("mail"),resetBtn=document.getElementById("reset"),C3_UNIT_CAP=2,$=(t,e=document)=>e.querySelector(t),$$=(t,e=document)=>Array.from(e.querySelectorAll(t));function el(t,e={}){const a=document.createElement(t);return Object.entries(e).forEach((([t,e])=>{"class"===t?a.className=e:"dataset"===t?Object.assign(a.dataset,e):"text"===t?a.textContent=e:a.setAttribute(t,e)})),a}function renderProductParagraph(t,e,a){if(!productDiv||!t)return;const o=t;const r=findPaletteEntryByPartID(o)||PALETTE_MAP.get(normalizePID(o))||null;let n=r?.name||o;"PB/TB"===normalizePID(o)&&(n="TRIPLE POLE BLANK"),"PB/SB"===normalizePID(o)&&(n="SINGLE POLE BLANK");const s=function(t){const e=t||"misc";let a=productDiv.querySelector(`.product-section[data-spec="${e}"]`);if(a)return a;a=el("div",{class:"product-section",dataset:{spec:e}});const o=el("div",{class:"product-section-heading"});o.textContent=function(t){const e=PICKERS.find((e=>e.id===t));return e?(e.title||"").replace(/^Step\s+[^:]+:\s*/i,"").trim():t||""}(t)||"Other",o.style.fontWeight="700",o.style.marginTop="8px",a.appendChild(o);const r=el("div",{class:"product-section-list"});a.appendChild(r);const n=PICKERS.map((t=>t.id));Array.from(productDiv.querySelectorAll(".product-section"));let s=!1;for(const t of n)if(t===e){for(let e=n.indexOf(t)+1;e<n.length;e++){const t=productDiv.querySelector(`.product-section[data-spec="${n[e]}"]`);if(t){productDiv.insertBefore(a,t),s=!0;break}}break}return s||productDiv.appendChild(a),a}(e),c=s.querySelector(".product-section-list")||s;let d=c.querySelector(`p[data-part-id="${o}"]`);d?d.dataset.spec=e||d.dataset.spec||"":(d=el("p"),d.dataset.partId=o,d.dataset.spec=e||"",c.appendChild(d)),d.innerHTML="";const i=el("span",{class:"product-name",text:n});if(d.appendChild(i),String(n).trim().toUpperCase()!==normalizePID(o)){const t=el("span",{class:"product-id",text:` ${o}`});d.appendChild(t)}const l=el("span",{class:"product-qty",text:"number"==typeof a&&a>1||"string"==typeof a&&a?` × ${a}`:""});l.textContent&&d.appendChild(l)}function normalizePID(t){return null==t?"":String(t).trim().toUpperCase()}const ALL_PALETTES_ARRAY=[].concat(PANEL_BOARD_BASE_SECTION,INCOMER_TYPES,SPINE_TYPES,OUTGOER_LESSTHAN_125A_TYPES,OUTGOER_125A_OR_MORE_TYPES,ACCESSORIES),PALETTE_MAP=new Map;function findPaletteEntryByPartID(t,e){if(Array.isArray(t)&&void 0!==e){const a=normalizePID(e);return t.find((t=>normalizePID(t.partID)===a||normalizePID(t.partId)===a||normalizePID(t.id)===a))||null}const a=normalizePID(t);return a&&PALETTE_MAP.get(a)||null}function getTotalPorts(){const t=state.c2[0];if(!t)return 18;const e=findPaletteEntryByPartID(SPINE_TYPES,t);return e&&e.max?3*e.max:18}function calculateUsedPortsForC4Model(){if(!Array.isArray(state.c4))return 0;const t=state.c4_qty||{};return state.c4.reduce(((e,a)=>{const o=findPaletteEntryByPartID(OUTGOER_LESSTHAN_125A_TYPES,a);if(!o)return e;return e+("number"==typeof t[a]?t[a]:1)*(o.spaceRequired||1)}),0)}function getC3CurrentUnits(){if(!Array.isArray(state.c3))return 0;const t=state.c3_qty||{};return state.c3.reduce(((e,a)=>e+("number"==typeof t[a]?t[a]:1)),0)}function getTotalOutgoerCount(){let t=0;if(Array.isArray(state.c3)){const e=state.c3_qty||{};state.c3.forEach((a=>{t+="number"==typeof e[a]?e[a]:1}))}if(Array.isArray(state.c4)){const e=state.c4_qty||{};state.c4.forEach((a=>{t+="number"==typeof e[a]?e[a]:1}))}return t}function computeBlanksForRemaining(t){if(t<=0)return{triple:0,single:0,remaining:0};return{triple:Math.floor(t/3),single:t%3,remaining:t}}function updateBlanksDisplay(){if(!productDiv)return;if(productDiv.querySelectorAll('p[data-part-id="PB/TB"], p[data-part-id="PB/SB"]').forEach((t=>t.remove())),!state.c2[0])return void Array.from(productDiv.querySelectorAll(".product-section")).forEach((t=>{const e=t.querySelector(".product-section-list");e&&0!==e.children.length||t.remove()}));const t=computeBlanksForRemaining(Math.max(0,getTotalPorts()-calculateUsedPortsForC4Model()));if(t.triple>0)renderProductParagraph("PB/TB","blanks",t.triple);else{const t=productDiv.querySelector('p[data-part-id="PB/TB"]');t&&t.remove()}if(t.single>0)renderProductParagraph("PB/SB","blanks",t.single);else{const t=productDiv.querySelector('p[data-part-id="PB/SB"]');t&&t.remove()}Array.from(productDiv.querySelectorAll(".product-section")).forEach((t=>{const e=t.querySelector(".product-section-list");e&&0!==e.children.length||t.remove()}));const e=pickersRoot?.querySelector('section[data-spec="c5"]');if(!e)return;const a=e.querySelector(".auto-blanks-note");a&&a.remove();const o=el("div",{class:"auto-blanks-note"});o.textContent=`Required blanks: ${t.triple} triple pole(s), ${t.single} single pole(s)`,e.appendChild(o)}function ensureSpaceBar(){const t=pickersRoot?.querySelector('section[data-spec="c4"]');if(!t)return;if(t.querySelector(".space-bar"))return;const e=el("div",{class:"space-bar"});e.appendChild(el("div",{class:"space-bar-fill"})),e.appendChild(el("div",{class:"space-bar-text"}));const a=t.querySelector(".swatch-grid");a?t.insertBefore(e,a):t.appendChild(e)}function updateSpaceBar(){const t=pickersRoot?.querySelector('section[data-spec="c4"]');if(!t)return;ensureSpaceBar();const e=getTotalPorts(),a=calculateUsedPortsForC4Model(),o=Math.min(100,Math.round(a/(e||1)*100)),r=t.querySelector(".space-bar-fill"),n=t.querySelector(".space-bar-text");r&&(r.style.width=o+"%"),n&&(n.textContent=`${a}/${e} ports used`);const s=document.getElementById("count-c4");s&&(s.textContent=String(a));const c=document.getElementById("max-c4");c&&(c.textContent=`Max selectable: ${e} ports`);const d=document.getElementById("count-c4-total");d&&(d.textContent=` / ${e} ports`),updateBlanksDisplay(),updateDownloadButtonState()}function createSwatchNode(t,e,a,o){const r=el("label",{class:"swatch",dataset:{partId:t}}),n=el("input");n.type="checkbox",n.name=a,n.value=t,n.className="swatch-input";const s=el("span",{class:"tick",text:"✓"}),c=el("span",{class:"swatch-label",text:e});if(r.appendChild(n),r.appendChild(s),r.appendChild(c),o){const e=el("div",{class:"qty-wrap"}),o=el("button");o.type="button",o.className="qty-minus",o.textContent="−";const n=el("span",{class:"qty"});n.textContent="1",n.dataset.value="1";const s=el("button");s.type="button",s.className="qty-plus",s.textContent="+";const c=t=>{t.preventDefault(),t.stopPropagation()};o.addEventListener("click",(e=>{c(e),handleQtyClick(a,t,-1)})),s.addEventListener("click",(e=>{c(e),handleQtyClick(a,t,1)})),e.appendChild(o),e.appendChild(n),e.appendChild(s),r.appendChild(e)}return r}function renderPickers(){if(!pickersRoot)return;pickersRoot.innerHTML="",PICKERS.forEach((t=>{const e=(t.title||"").split(":"),a=(e[0]||"").trim(),o=(e.slice(1).join(":")||t.title).trim(),r=el("div",{class:"step-row"}),n=el("div",{class:"step-label",text:a}),s=el("div",{class:"step-divider"});r.appendChild(n),r.appendChild(s),pickersRoot.appendChild(r);const c=el("section");c.className="section",c.dataset.spec=t.id;const d=el("div",{class:"picker-heading"}),i=el("span",{class:"picker-title",text:o}),l=el("img",{class:"picker-icon",src:`productImages/${o.replace(/^Step\s+[^:]+:\s*/i,"").trim()}.jpg`,alt:`${t.title} icon`});l.addEventListener("click",(e=>{e.stopPropagation(),showImageModal&&showImageModal(l.src,t.title)})),d.appendChild(i),d.appendChild(l),c.appendChild(d),"c4"===t.id&&c.appendChild(el("div",{class:"space-bar-placeholder"}));const p=el("div",{class:"swatch-grid"});(t.palette||[]).forEach((e=>{const a=createSwatchNode(e.partID,e.name,t.id,!!t.allowQuantity),o=state[t.id].includes(e.partID);a.dataset.checked=o?"true":"false";const r=a.querySelector("input");r.checked=o,o&&a.classList.add("show-qty");const n=a.querySelector(".qty");if(n){const a=state[t.id+"_qty"]&&"number"==typeof state[t.id+"_qty"][e.partID]?state[t.id+"_qty"][e.partID]:1;n.dataset.value=String(a),n.textContent=String(a)}r.addEventListener("change",(()=>handleCheckboxChange(t,e,r,a,p))),p.appendChild(a)})),c.appendChild(p);const u=el("div",{class:"field-note"}),y=el("span",{class:"count-wrapper"});y.id=`count-${t.id}-wrapper`;const C=el("strong");if(C.id=`count-${t.id}`,"c4"===t.id){C.textContent=String(calculateUsedPortsForC4Model()),y.innerHTML="Used: ",y.appendChild(C);const t=el("span");t.id="count-c4-total",t.textContent=` / ${getTotalPorts()} ports`,y.appendChild(t)}else if("c3"===t.id)C.textContent=String(getC3CurrentUnits()),y.innerHTML="Selected units: ",y.appendChild(C),y.insertAdjacentText("beforeend",` / ${C3_UNIT_CAP}`);else{C.textContent=String(state[t.id].length);const e=t.max||("multi"===t.type?2:1);y.innerHTML="Selected: ",y.appendChild(C),y.insertAdjacentText("beforeend",` / ${e}`)}if(u.appendChild(y),"multi"===t.type){const e=el("div",{class:"max-label"});e.id=`max-${t.id}`,e.style.color="var(--muted)",e.style.fontSize="12px","c4"===t.id?e.textContent=`Max selectable: ${getTotalPorts()} ports`:"c3"===t.id?e.textContent=`Max units: ${C3_UNIT_CAP}`:e.textContent=`Max selectable: ${t.max||2}`,u.appendChild(e)}c.appendChild(u),pickersRoot.appendChild(c)}));const t=el("hr");t.style.border="none",t.style.borderTop="2px solid #641b1F",t.style.margin="16px 0",pickersRoot.appendChild(t);const e=el("section");e.className="section",e.dataset.spec="extra-notes";const a=el("div",{class:"picker-heading"}),o=el("span",{class:"picker-title",text:"Extra Notes"});a.appendChild(o),e.appendChild(a);const r=el("div",{class:"field-note"}),n=el("textarea",{id:"extra-notes-textarea",placeholder:"Any extra notes, comments, or special requirements...",rows:"4"});n.value=state.extraNotes||"",n.addEventListener("input",(()=>{state.extraNotes=n.value})),r.appendChild(n),e.appendChild(r),pickersRoot.appendChild(e);const s=el("div",{class:"disclaimer-wrap"}),c=el("input");c.type="checkbox",c.id="disclaimer-checkbox",c.checked=!!state.disclaimerAgreed;const d=el("label");d.setAttribute("for","disclaimer-checkbox"),d.textContent="I agree to be contacted about my enquiry and understand my information will only be used for this purpose.",s.appendChild(c),s.appendChild(d),c.addEventListener("change",(t=>{state.disclaimerAgreed=!!t.target.checked,updateDownloadButtonState()})),pickersRoot.appendChild(s),updateSpaceBar(),updateBlanksDisplay(),updateCounters(),updateDownloadButtonState()}function updateTerminalShrouds(){const t=getTotalOutgoerCount(),e=(state.c5_qty,state.c5.includes(TERMINAL_SHROUD_PID)),a=t=>{if(productDiv)if(t>0)renderProductParagraph(TERMINAL_SHROUD_PID,"c5",t);else{const t=productDiv.querySelector(`p[data-part-id="${TERMINAL_SHROUD_PID}"]`);t&&t.remove()}};if(t<=0){e&&(state.c5=state.c5.filter((t=>t!==TERMINAL_SHROUD_PID))),state.c5_qty&&(state.c5_qty[TERMINAL_SHROUD_PID]=void 0),state.terminalShroudUserChanged=!1,a(0);const t=pickersRoot?.querySelector(`section[data-spec="c5"] .swatch[data-part-id="${TERMINAL_SHROUD_PID}"]`);if(t){t.dataset.checked="false",t.classList.remove("show-qty");const e=t.querySelector("input");e&&(e.checked=!1);const a=t.querySelector(".qty");a&&(a.dataset.value="1",a.textContent="1")}return updateCounters(),updateTotalCost(),void updateDownloadButtonState()}if(state.terminalShroudUserChanged&&!e)return a(0),state.c5_qty&&(state.c5_qty[TERMINAL_SHROUD_PID]=void 0),updateCounters(),updateTotalCost(),void updateDownloadButtonState();e||state.c5.push(TERMINAL_SHROUD_PID),state.c5_qty||(state.c5_qty={});null===("number"==typeof state.c5_qty[TERMINAL_SHROUD_PID]?state.c5_qty[TERMINAL_SHROUD_PID]:null)?(state.c5_qty[TERMINAL_SHROUD_PID]=t,state.terminalShroudUserChanged=!1):state.terminalShroudUserChanged?state.c5_qty[TERMINAL_SHROUD_PID]>t&&(state.c5_qty[TERMINAL_SHROUD_PID]=t):state.c5_qty[TERMINAL_SHROUD_PID]=t,a(state.c5_qty[TERMINAL_SHROUD_PID]);const o=pickersRoot?.querySelector(`section[data-spec="c5"] .swatch[data-part-id="${TERMINAL_SHROUD_PID}"]`);if(o){const t=o.querySelector(".qty");o.dataset.checked="true",o.classList.add("show-qty");const e=o.querySelector("input");e&&(e.checked=!0),t&&(t.dataset.value=String(state.c5_qty[TERMINAL_SHROUD_PID]),t.textContent=String(state.c5_qty[TERMINAL_SHROUD_PID]))}updateCounters(),updateTotalCost(),updateDownloadButtonState()}function handleCheckboxChange(t,e,a,o,r){const n=e.partID;if("c5"===t.id&&n===TERMINAL_SHROUD_PID&&(a.checked?state.terminalShroudUserChanged=!1:state.terminalShroudUserChanged=!0),"single"===t.type)if(a.checked){state[t.id]=[n],r.querySelectorAll(".swatch").forEach((e=>{const a=e.querySelector("input").value;if(a===n)e.dataset.checked="true",e.querySelector("input").checked=!0,e.classList.add("show-qty");else{e.dataset.checked="false",e.querySelector("input").checked=!1,e.classList.remove("show-qty"),document.querySelectorAll(`.product p[data-part-id="${a}"]`).forEach((t=>t.remove())),t.allowQuantity&&(state[t.id+"_qty"][a]=void 0);const o=e.querySelector(".qty");o&&(o.dataset.value="1",o.textContent="1")}})),document.querySelectorAll(`.product p[data-spec="${t.id}"]`).forEach((t=>t.remove()));const e=t.allowQuantity&&state[t.id+"_qty"][n]||1;renderProductParagraph(n,t.id,e),t.allowQuantity&&(state[t.id+"_qty"][n]=state[t.id+"_qty"][n]||1)}else state[t.id]=[],productDiv?.querySelectorAll(`p[data-spec="${t.id}"]`).forEach((t=>t.remove())),o.dataset.checked="false",o.classList.remove("show-qty"),t.allowQuantity&&(state[t.id+"_qty"]={});else{const e=new Set(state[t.id]);if(a.checked){if("c4"===t.id){const e=findPaletteEntryByPartID(t.palette,n),o=e&&e.spaceRequired||1,r=getTotalPorts();if(calculateUsedPortsForC4Model()+o>r)return void(a.checked=!1)}else if("c3"===t.id){if(getC3CurrentUnits()+1>C3_UNIT_CAP)return void(a.checked=!1)}else if(e.size>=(t.max||2)){const a=state[t.id][0];e.delete(a);const o=r.querySelector(`.swatch[data-part-id="${a}"]`);if(o){o.dataset.checked="false",o.querySelector("input").checked=!1,o.classList.remove("show-qty");const e=document.querySelector(`.product p[data-part-id="${a}"]`);e&&e.remove(),t.allowQuantity&&(state[t.id+"_qty"][a]=void 0);const r=o.querySelector(".qty");r&&(r.dataset.value="1",r.textContent="1")}}if(e.add(n),o.dataset.checked="true",o.classList.add("show-qty"),t.allowQuantity&&(state[t.id+"_qty"][n]=state[t.id+"_qty"][n]||1),n!==TERMINAL_SHROUD_PID){const e=t.allowQuantity&&state[t.id+"_qty"][n]||1;renderProductParagraph(n,t.id,e)}}else{e.delete(n),o.dataset.checked="false",o.classList.remove("show-qty");const a=productDiv?.querySelector(`p[data-part-id="${n}"]`);a&&a.remove(),t.allowQuantity&&(state[t.id+"_qty"][n]=void 0);const r=o.querySelector(".qty");r&&(r.dataset.value="1",r.textContent="1")}state[t.id]=Array.from(e)}if("c4"===t.id&&enforcePortsForC4(),"c3"===t.id&&getC3CurrentUnits()>C3_UNIT_CAP&&freeUpC3Units(C3_UNIT_CAP),updateCounters(),updateTotalCost(),"c2"===t.id){updateOutgoerAvailability(),enforcePortsForC4();calculateUsedPortsForC4Model()>getTotalPorts()&&resetC4Selections()}"c4"===t.id&&updateSpaceBar(),updateTerminalShrouds()}function handleQtyClick(t,e,a){const o=PICKERS.find((e=>e.id===t));if(!o||!o.allowQuantity)return;const r=pickersRoot?.querySelector(`section[data-spec="${t}"] .swatch[data-part-id="${e}"]`);if(!r)return;const n=r.querySelector("input");if(!n.checked&&a>0)return n.checked=!0,void n.dispatchEvent(new Event("change",{bubbles:!0}));const s=state[t+"_qty"]||{},c="number"==typeof s[e]?s[e]:1,d=c+a;if(d<=0)return"c5"===t&&e===TERMINAL_SHROUD_PID&&(state.terminalShroudUserChanged=!0),n.checked=!1,void n.dispatchEvent(new Event("change",{bubbles:!0}));if("c4"===t){const t=findPaletteEntryByPartID(OUTGOER_LESSTHAN_125A_TYPES,e),a=t&&t.spaceRequired||1;if(calculateUsedPortsForC4Model()+(d-c)*a>getTotalPorts())return}else if("c3"===t){if(getC3CurrentUnits()+(d-c)>C3_UNIT_CAP)return}else if("c5"===t&&e===TERMINAL_SHROUD_PID){const t=getTotalOutgoerCount();if(d>t)return;d!==t&&(state.terminalShroudUserChanged=!0)}state[t+"_qty"][e]=d;const i=r.querySelector(".qty");i&&(i.dataset.value=String(d),i.textContent=String(d)),renderProductParagraph(e,t,d),updateSpaceBar(),updateTotalCost(),updateCounters(),("c3"===t||"c4"===t||"c5"===t&&e===TERMINAL_SHROUD_PID)&&updateTerminalShrouds()}function freeUpC3Units(t){for(;getC3CurrentUnits()>t&&state.c3.length>0;){const t=state.c3.shift();state.c3_qty&&(state.c3_qty[t]=void 0);const e=document.querySelector(`.product p[data-part-id="${t}"]`);e&&e.remove();const a=pickersRoot?.querySelector(`section[data-spec="c3"] .swatch[data-part-id="${t}"]`);if(a){const t=a.querySelector("input");t&&(t.checked=!1),a.dataset.checked="false",a.classList.remove("show-qty");const e=a.querySelector(".qty");e&&(e.dataset.value="1",e.textContent="1")}}}function enforcePortsForC4(){const t=getTotalPorts();let e=calculateUsedPortsForC4Model();for(;e>t&&state.c4.length>0;){const t=state.c4.shift();state.c4_qty&&(state.c4_qty[t]=void 0);const a=document.querySelector(`.product p[data-part-id="${t}"]`);a&&a.remove();const o=pickersRoot?.querySelector(`section[data-spec="c4"] .swatch[data-part-id="${t}"]`);if(o){const t=o.querySelector("input");t&&(t.checked=!1),o.dataset.checked="false",o.classList.remove("show-qty");const e=o.querySelector(".qty");e&&(e.dataset.value="1",e.textContent="1")}e=calculateUsedPortsForC4Model()}updateCounters(),updateTotalCost(),updateDownloadButtonState(),updateTerminalShrouds()}function resetC4Selections(){Array.isArray(state.c4)||(state.c4=[]),state.c4.forEach((t=>{state.c4_qty&&(state.c4_qty[t]=void 0);const e=document.querySelector(`.product p[data-part-id="${t}"]`);e&&e.remove();const a=pickersRoot?.querySelector(`section[data-spec="c4"] .swatch[data-part-id="${t}"]`);if(a){const t=a.querySelector("input");t&&(t.checked=!1),a.dataset.checked="false",a.classList.remove("show-qty");const e=a.querySelector(".qty");e&&(e.dataset.value="1",e.textContent="1")}})),state.c4=[],setTimeout((()=>{updateSpaceBar(),updateBlanksDisplay(),updateCounters(),updateTotalCost(),updateTerminalShrouds(),updateDownloadButtonState()}),0)}function updateOutgoerAvailability(){const t=pickersRoot?.querySelector('section[data-spec="c3"]');if(!t)return;const e=state.c2[0];let a=!1;if(e){const t=findPaletteEntryByPartID(SPINE_TYPES,e);t&&t.supportsLargeOutgoer&&(a=!0)}t.querySelectorAll(".swatch").forEach((t=>{if(a)t.classList.remove("disabled"),t.dataset.disabled="false";else{if("true"===t.dataset.checked){const e=t.querySelector("input");if(e){const a=e.value;e.checked=!1,t.dataset.checked="false";const o=document.querySelector(`.product p[data-part-id="${a}"]`);o&&o.remove()}}t.classList.add("disabled"),t.dataset.disabled="true"}})),a||(Array.isArray(state.c3)&&state.c3.forEach((t=>{state.c3_qty&&(state.c3_qty[t]=void 0)})),state.c3=[]),updateSpaceBar(),updateBlanksDisplay(),updateCounters(),updateTerminalShrouds(),updateDownloadButtonState()}function updateCounters(){PICKERS.forEach((t=>{const e=document.getElementById(`count-${t.id}`);e&&("c4"===t.id?e.textContent=String(calculateUsedPortsForC4Model()):"c3"===t.id?e.textContent=String(getC3CurrentUnits()):e.textContent=String(state[t.id].length))})),updateTotalCost()}function updateTotalCost(){let t=0;PICKERS.forEach((e=>{const a=e.palette||[];state[e.id].forEach((o=>{const r=findPaletteEntryByPartID(a,o);if(!r)return;let n=1;e.allowQuantity&&state[e.id+"_qty"]&&(n="number"==typeof state[e.id+"_qty"][o]?state[e.id+"_qty"][o]:1),t+=(r.cost||0)*n}))}));const e=document.getElementById("total-cost");e&&(e.textContent=`Total Cost: £${t}`),updateDownloadButtonState()}function updateDownloadButtonState(){if(!downloadBtn)return;const t=calculateUsedPortsForC4Model(),e=getTotalPorts(),a=productDiv&&productDiv.querySelectorAll("p").length>0,o=t>e||!a||!state.disclaimerAgreed;downloadBtn.disabled=o,downloadBtn.style.pointerEvents=o?"none":"",downloadBtn.style.opacity=o?"0.45":"",mailBtn&&(mailBtn.style.pointerEvents=o?"none":"",mailBtn.style.opacity=o?"0.45":"")}function generateCSVContent(){if(!productDiv)return"";if(!state.disclaimerAgreed)return"";if(calculateUsedPortsForC4Model()>getTotalPorts())return"";const t=t=>{if(null==t)return"";const e=String(t);return e.includes('"')||e.includes(",")||e.includes("\n")?'"'+e.replace(/"/g,'""')+'"':e},e=[];e.push("Name,Part Number,Quantity");PICKERS.forEach((a=>{(Array.isArray(state[a.id])?state[a.id]:[]).forEach((o=>{if(!o)return;const r=PALETTE_MAP.get(normalizePID(o))||null,n=r?.name||o,s=a.allowQuantity?((t,e)=>{if(!t||!e)return 1;const a=state[t+"_qty"];return a&&Object.prototype.hasOwnProperty.call(a,e)&&"number"==typeof a[e]?a[e]:1})(a.id,o):1;e.push([t(n),t(o),s].join(","))}))}));return Array.from(productDiv.querySelectorAll("p")).forEach((a=>{const o=a.dataset.partId||"";if(!o)return;if(PICKERS.some((t=>Array.isArray(state[t.id])&&state[t.id].some((t=>normalizePID(t)===normalizePID(o))))))return;let r=1;if(PICKERS.forEach((t=>{t.allowQuantity&&state[t.id+"_qty"]&&Object.prototype.hasOwnProperty.call(state[t.id+"_qty"],o)&&(r=state[t.id+"_qty"][o])})),"number"!=typeof r){const t=a.textContent.match(/[×x]\s*(\d+)$/);t&&(r=Number(t[1]))}const n=PALETTE_MAP.get(normalizePID(o)),s=n?.name||a.textContent.replace(/[\s]*[×x]\s*\d+$/,"").trim()||o;e.push([t(s),t(o),r].join(","))})),e.join("\n")}function downloadCSV(){if(!productDiv)return;if(calculateUsedPortsForC4Model()>getTotalPorts())return;const t=generateCSVContent();if(!t)return;const e=new Blob([t],{type:"text/csv"}),a=URL.createObjectURL(e),o=el("a");o.href=a,o.download="products.csv",document.body.appendChild(o),o.click(),o.remove();try{URL.revokeObjectURL(a)}catch(t){}}function mailToCSV(){if(!productDiv)return;if(calculateUsedPortsForC4Model()>getTotalPorts())return;const t=generateCSVContent();if(!t)return;const e=new Blob([t],{type:"text/csv"}),a=URL.createObjectURL(e),o=el("a");o.href=a,o.download="products.csv",document.body.appendChild(o),o.click(),document.body.removeChild(o);let r="Please attach the downloaded products.csv file to this email.\n\n";"string"==typeof state.extraNotes&&state.extraNotes.trim().length>0?r+="Extra Notes:\n"+state.extraNotes.trim():r+="(No extra notes provided)";const n=`mailto:example@test.com?cc=test2&subject=${encodeURIComponent("Switchboard Quote")}&body=${encodeURIComponent(r)}`;setTimeout((()=>{try{URL.revokeObjectURL(a)}catch(t){}window.location.href=n}),400)}function resetApp(){PICKERS.forEach((t=>{state[t.id]=[],t.allowQuantity&&(state[t.id+"_qty"]={})})),state.terminalShroudUserChanged=!1,state.extraNotes="",productDiv&&(productDiv.innerHTML=""),renderPickers(),updateOutgoerAvailability(),updateTotalCost(),updateDownloadButtonState();const t=document.getElementById("extra-notes-textarea");t&&(t.value="")}ALL_PALETTES_ARRAY.forEach((t=>{t&&t.partID&&PALETTE_MAP.set(normalizePID(t.partID),t)}));let _imageModal=null;function createImageModal(){if(_imageModal)return _imageModal;const t=el("div",{class:"image-modal"});t.innerHTML='\n    <div class="image-modal-backdrop" data-role="backdrop"></div>\n    <div class="image-modal-content" role="dialog" aria-modal="true">\n      <button class="image-modal-close" aria-label="Close image">✕</button>\n      <img alt="" />\n    </div>\n  ',document.body.appendChild(t);const e=t.querySelector(".image-modal-close"),a=t.querySelector('[data-role="backdrop"]'),o=t.querySelector("img"),r=()=>{t.classList.remove("visible"),o.src="",o.alt=""};e.addEventListener("click",(t=>{t.stopPropagation(),r()})),a.addEventListener("click",r);return document.addEventListener("keydown",(t=>{"Escape"===t.key&&r()})),_imageModal={modal:t,img:o,show:(e,a="")=>{o.src=e,o.alt=a,t.classList.add("visible")},hide:r},_imageModal}function showImageModal(t,e){createImageModal().show(t,e)}resetBtn?.addEventListener("click",resetApp),downloadBtn?.addEventListener("click",downloadCSV),mailBtn?.addEventListener("click",mailToCSV),renderPickers(),updateOutgoerAvailability(),updateSpaceBar(),updateBlanksDisplay(),updateTerminalShrouds(),updateDownloadButtonState();
