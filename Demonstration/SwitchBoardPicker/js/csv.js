function generateCSVContent(){if(!productDiv)return"";if(!state.disclaimerAgreed)return"";if(calculateUsedPortsForC4Model()>getTotalPorts())return"";const t=t=>{if(null==t)return"";const e=String(t),o=sanitizeCSVValue(e);return o.includes('"')||o.includes(",")||o.includes("\n")?'"'+o.replace(/"/g,'""')+'"':o},e=[];e.push("Name,Part Number,Quantity");PICKERS.forEach((o=>{(Array.isArray(state[o.id])?state[o.id]:[]).forEach((r=>{if(!r)return;const n=PALETTE_MAP.get(normalizePID(r))||null,a=n?.name||r,i=o.allowQuantity?((t,e)=>{if(!t||!e)return 1;const o=state[t+"_qty"];return o&&Object.prototype.hasOwnProperty.call(o,e)&&"number"==typeof o[e]?o[e]:1})(o.id,r):1;e.push([t(a),t(r),i].join(","))}))}));return Array.from(productDiv.querySelectorAll("p")).forEach((o=>{const r=o.dataset.partId||"";if(!r)return;if(PICKERS.some((t=>Array.isArray(state[t.id])&&state[t.id].some((t=>normalizePID(t)===normalizePID(r))))))return;let n=1;const a=normalizePID(r);if("PB/TB"===a||"PB/SB"===a){const t=Math.max(0,getTotalPorts()-calculateUsedPortsForC4Model()),e=computeBlanksForRemaining(t);if(n="PB/TB"===a?e.triple:e.single,!n||n<=0)return}else if(PICKERS.forEach((t=>{t.allowQuantity&&state[t.id+"_qty"]&&Object.prototype.hasOwnProperty.call(state[t.id+"_qty"],r)&&(n=state[t.id+"_qty"][r])})),"number"!=typeof n){const t=o.textContent.match(/[×x]\s*(\d+)$/);t&&(n=Number(t[1]))}const i=PALETTE_MAP.get(normalizePID(r)),c=i?.name||o.textContent.replace(/[\s]*[×x]\s*\d+$/,"").trim()||r;e.push([t(c),t(r),n].join(","))})),e.join("\n")}function downloadCSV(){if(!checkRateLimit("Download"))return;if(!productDiv)return;if(calculateUsedPortsForC4Model()>getTotalPorts())return;const t=checkDownloadWarnings();showDownloadWarningDialog(t).then((t=>{if(!t)return;const e=generateCSVContent();if(!e)return;const o=new Blob([e],{type:"text/csv"}),r=URL.createObjectURL(o),n=el("a");n.href=r,n.download="products.csv",document.body.appendChild(n),n.click(),n.remove();try{URL.revokeObjectURL(r)}catch(t){}}))}function mailToCSV(){if(!checkRateLimit("Mail"))return;if(!productDiv)return;if(calculateUsedPortsForC4Model()>getTotalPorts())return;const t=generateCSVContent();if(!t)return;const e=new Blob([t],{type:"text/csv"}),o=URL.createObjectURL(e),r=el("a");r.href=o,r.download="products.csv",document.body.appendChild(r),r.click(),document.body.removeChild(r);let n="Please attach the downloaded products.csv file to this email.\n\n";if("string"==typeof state.extraNotes&&state.extraNotes.trim().length>0){n+="Extra Notes:\n"+escapeCRLF(state.extraNotes.trim())}else n+="(No extra notes provided)";const a=`mailto:example@test.com?cc=test2&subject=${encodeURIComponent("Switchboard Quote")}&body=${encodeURIComponent(n)}`;setTimeout((()=>{try{URL.revokeObjectURL(o)}catch(t){}window.location.href=a}),400)}function resetApp(){if(!checkRateLimit("Reset"))return;PICKERS.forEach((t=>{state[t.id]=[],t.allowQuantity&&(state[t.id+"_qty"]={})})),state.terminalShroudUserChanged=!1,state.extraNotes="",productDiv&&(productDiv.innerHTML=""),renderPickers(),updateOutgoerAvailability(),updateTotalCost(),updateDownloadButtonState();const t=document.getElementById("extra-notes-textarea");t&&(t.value="")}